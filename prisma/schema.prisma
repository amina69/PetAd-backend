generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
}

// ─── Enums ───────────────────────────────────────────────

enum UserRole {
  USER
  ADMIN
  SHELTER
}

enum PetSpecies {
  DOG
  CAT
  BIRD
  RABBIT
  OTHER
}

enum PetStatus {
  AVAILABLE
  PENDING
  IN_CUSTODY
  ADOPTED
}

enum AdoptionStatus {
  REQUESTED
  PENDING_REVIEW
  PENDING
  APPROVED
  ESCROW_FUNDED
  COMPLETED
  REJECTED
  CANCELLED
  REFUNDED
}

enum CustodyStatus {
  PENDING
  ACTIVE
  RETURNED
  CANCELLED
  VIOLATION
}

enum CustodyType {
  OWNER
  TEMPORARY
  SHELTER
}



enum EscrowStatus {
  CREATED
  FUNDED
  RELEASED
  REFUNDED
  DISPUTED
}


enum EventEntityType {
  USER
  PET
  ADOPTION
  CUSTODY
  ESCROW
}


enum EventType {
  USER_REGISTERED
  PET_REGISTERED
  PET_STATUS_CHANGED
  ADOPTION_REQUESTED
  ADOPTION_APPROVED
  ADOPTION_COMPLETED
  CUSTODY_STARTED
  CUSTODY_RETURNED
  ESCROW_CREATED
  ESCROW_FUNDED
  ESCROW_RELEASED
  TRUST_SCORE_UPDATED
}

enum PetGender {
  MALE
  FEMALE
}

enum PetSize {
  SMALL
  MEDIUM
  LARGE
}

// ─── Models ──────────────────────────────────────────────

model User {
  id        String   @id @default(uuid())
  email     String   @unique
  password  String
  firstName String   @map("first_name")
  lastName  String   @map("last_name")
  role      UserRole @default(USER)

  trustScore Float   @default(50)



  stellarPublicKey String? @unique @map("stellar_public_key")
  avatarUrl        String? @map("avatar_url")

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  petsOwned   Pet[] @relation("PetOwner")

  adoptionsAsAdopter Adoption[] @relation("Adopter")
  adoptionsAsOwner   Adoption[] @relation("Owner")

  custodiesHeld Custody[] @relation("CustodyHolder")


  events EventLog[] @relation("ActorEvents")

  @@map("users")
}



model Pet {

  id          String      @id @default(uuid())
  name        String
  species     PetSpecies
  breed       String?
  age         Int?
  description String?
  imageUrl    String?     @map("image_url")

  gender      PetGender?   // Optional gender field
  size        PetSize?     // Optional size field

  currentOwnerId String?  @map("current_owner_id")
  currentOwner   User?    @relation("PetOwner", fields: [currentOwnerId], references: [id])

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  adoptions Adoption[]
  custodies Custody[]

  @@index([species])
  @@index([currentOwnerId])
  @@map("pets")
}


model Adoption {

  id     String         @id @default(uuid())
  status AdoptionStatus @default(REQUESTED)
  notes  String?

  petId String @map("pet_id")
  pet   Pet    @relation(fields: [petId], references: [id], onDelete: Cascade)

  adopterId String @map("adopter_id")
  adopter   User   @relation("Adopter", fields: [adopterId], references: [id])

  ownerId String @map("owner_id")
  owner   User   @relation("Owner", fields: [ownerId], references: [id])

  escrowId String?  @unique @map("escrow_id")
  escrow   Escrow? @relation(fields: [escrowId], references: [id])
  

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@index([status])
  @@index([adopterId])
  @@index([ownerId])
  @@map("adoptions")
}



model Custody {
  
  id       String        @id @default(uuid())
  status   CustodyStatus @default(ACTIVE)
  type     CustodyType

  depositAmount Decimal? @db.Decimal(12, 2)

  startDate DateTime @map("start_date")
  endDate   DateTime?

  petId String @map("pet_id")
  pet   Pet    @relation(fields: [petId], references: [id], onDelete: Cascade)

  holderId String @map("holder_id")
  holder   User   @relation("CustodyHolder", fields: [holderId], references: [id])

  escrowId String? @unique @map("escrow_id")
  escrow   Escrow? @relation(fields: [escrowId], references: [id])

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@index([status])
  @@index([holderId])
  @@map("custodies")
}


model Escrow {
  id String @id @default(uuid())

  stellarPublicKey String @unique @map("stellar_public_key")
  stellarSecretEncrypted String @map("stellar_secret_encrypted")

  assetCode String @default("XLM") @map("asset_code")
  assetIssuer String? @map("asset_issuer")

  amount Decimal @db.Decimal(12, 2)

  fundingTxHash  String? @map("funding_tx_hash")
  releaseTxHash  String? @map("release_tx_hash")
  refundTxHash   String? @map("refund_tx_hash")

  requiredSignatures Int @default(2)

  status EscrowStatus @default(CREATED)

  adoption Adoption?
  custody  Custody?

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@index([status])
  @@map("escrows")
}

model EventLog {
  id          String           @id @default(uuid())
  entityType  EventEntityType  @map("entity_type")
  entityId    String           @map("entity_id")
  eventType   EventType        @map("event_type")

  actorId String? @map("actor_id")
  actor   User?   @relation("ActorEvents", fields: [actorId], references: [id])

  txHash      String? @map("tx_hash")
  blockHeight Int?    @map("block_height")

  payload  Json
  metadata Json?

  createdAt DateTime @default(now()) @map("created_at")

  @@index([entityType, entityId])
  @@index([eventType])
  @@index([createdAt])
  @@map("event_logs")
}