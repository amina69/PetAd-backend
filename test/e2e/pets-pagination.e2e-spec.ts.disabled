import { Test, TestingModule } from '@nestjs/testing';
import { INestApplication, ValidationPipe } from '@nestjs/common';
import request from 'supertest';
import * as bcrypt from 'bcryptjs';
import { AppModule } from '../../src/app.module';
import { PrismaService } from '../../src/prisma/prisma.service';
import { PetStatus, UserRole, PetSpecies } from '../../src/common/enums';

/* eslint-disable @typescript-eslint/no-unsafe-call,
   @typescript-eslint/no-unsafe-member-access,
   @typescript-eslint/no-unsafe-assignment,
   @typescript-eslint/no-unsafe-argument,
   @typescript-eslint/no-unsafe-return,
   @typescript-eslint/no-unused-vars */

describe('Pet Pagination (E2E)', () => {
  let app: INestApplication;
  let prismaService: PrismaService;
  let userId: string;

  beforeAll(async () => {
    const moduleFixture: TestingModule = await Test.createTestingModule({
      imports: [AppModule],
    }).compile();

    app = moduleFixture.createNestApplication();
    app.useGlobalPipes(
      new ValidationPipe({
        whitelist: true,
        forbidNonWhitelisted: true,
        transform: true,
      }),
    );
    await app.init();

    prismaService = moduleFixture.get<PrismaService>(PrismaService);

    // Clean up database before tests
    await prismaService.pet.deleteMany({});
    await prismaService.user.deleteMany({});

    // Create admin user
    const hashedAdminPassword = await bcrypt.hash('Admin@123', 10);
    const adminUser = await prismaService.user.create({
      data: {
        email: 'admin@pagination-test.com',
        password: hashedAdminPassword,
        firstName: 'Admin',
        lastName: 'User',
        role: UserRole.ADMIN,
      },
    });

    userId = adminUser.id;


    // Seed 45 pets with various attributes - one by one to ensure consistent ordering
    for (let i = 1; i <= 45; i++) {
      await prismaService.pet.create({
        data: {
          name: `Pet ${i}`,
          species: i % 3 === 0 ? PetSpecies.CAT : PetSpecies.DOG,
          breed: i % 2 === 0 ? 'Golden Retriever' : 'Labrador',
          age: (i % 10) + 1,
          description: `Test pet number ${i}`,
          imageUrl: `https://example.com/pet${i}.jpg`,
          currentOwnerId: userId,
        },
      });
    }
  }, 30000);

  afterAll(async () => {
    await app.close();
  }, 30000);

  describe('Basic Pagination', () => {
    it('should return first 20 pets by default', async () => {
      const res = await request(app.getHttpServer())
        .get('/pets')
        .expect(200);

      expect(res.body).toHaveProperty('data');
      expect(res.body).toHaveProperty('meta');
      expect(res.body.data).toHaveLength(20);
      expect(res.body.meta.page).toBe(1);
      expect(res.body.meta.limit).toBe(20);
      expect(res.body.meta.total).toBe(45);
      expect(res.body.meta.totalPages).toBe(3);
      expect(res.body.meta.hasNextPage).toBe(true);
      expect(res.body.meta.hasPreviousPage).toBe(false);
    });

    it('should return page 2 with limit 10', async () => {
      const res = await request(app.getHttpServer())
        .get('/pets?page=2&limit=10')
        .expect(200);

      expect(res.body.data).toHaveLength(10);
      expect(res.body.meta.page).toBe(2);
      expect(res.body.meta.limit).toBe(10);
      expect(res.body.meta.hasNextPage).toBe(true);
      expect(res.body.meta.hasPreviousPage).toBe(true);
    });

    it('should return last page correctly', async () => {
      const res = await request(app.getHttpServer())
        .get('/pets?page=3&limit=20')
        .expect(200);

      expect(res.body.data).toHaveLength(5); // 45 total, page 3 has 5 items
      expect(res.body.meta.page).toBe(3);
      expect(res.body.meta.hasNextPage).toBe(false);
      expect(res.body.meta.hasPreviousPage).toBe(true);
    });

    it('should handle custom limit', async () => {
      const res = await request(app.getHttpServer())
        .get('/pets?limit=5')
        .expect(200);

      expect(res.body.data).toHaveLength(5);
      expect(res.body.meta.limit).toBe(5);
      expect(res.body.meta.totalPages).toBe(9); // 45 / 5 = 9
    });
  });

  describe('Validation', () => {
    it('should reject page 0', async () => {
      const res = await request(app.getHttpServer())
        .get('/pets?page=0')
        .expect(400);

      expect(res.body.message).toContain('Page must be at least 1');
    });

    it('should reject negative page', async () => {
      const res = await request(app.getHttpServer())
        .get('/pets?page=-1')
        .expect(400);

      expect(res.body.message).toContain('Page must be at least 1');
    });

    it('should reject limit 101', async () => {
      const res = await request(app.getHttpServer())
        .get('/pets?limit=101')
        .expect(400);

      expect(res.body.message).toContain('Limit cannot exceed 100');
    });

    it('should reject negative limit', async () => {
      const res = await request(app.getHttpServer())
        .get('/pets?limit=-5')
        .expect(400);

      expect(res.body.message).toContain('Limit must be at least 1');
    });

    it('should reject limit 0', async () => {
      const res = await request(app.getHttpServer())
        .get('/pets?limit=0')
        .expect(400);

      expect(res.body.message).toContain('Limit must be at least 1');
    });

    it('should reject non-integer page', async () => {
      const res = await request(app.getHttpServer())
        .get('/pets?page=abc')
        .expect(400);

      expect(res.body.message).toContain('Page must be an integer');
    });

    it('should reject non-integer limit', async () => {
      const res = await request(app.getHttpServer())
        .get('/pets?limit=xyz')
        .expect(400);

      expect(res.body.message).toContain('Limit must be an integer');
    });

    it('should reject decimal page', async () => {
      const res = await request(app.getHttpServer())
        .get('/pets?page=1.5')
        .expect(400);

      expect(res.body.message).toContain('Page must be an integer');
    });
  });

  describe('Metadata Accuracy', () => {
    it('should calculate totalPages correctly', async () => {
      const res = await request(app.getHttpServer())
        .get('/pets?limit=10')
        .expect(200);

      expect(res.body.meta.totalPages).toBe(5); // 45 / 10 = 5
    });

    it('should set hasNextPage correctly on middle page', async () => {
      const res = await request(app.getHttpServer())
        .get('/pets?page=2&limit=10')
        .expect(200);

      expect(res.body.meta.hasNextPage).toBe(true);
      expect(res.body.meta.hasPreviousPage).toBe(true);
    });

    it('should set hasNextPage correctly on last page', async () => {
      const res = await request(app.getHttpServer())
        .get('/pets?page=5&limit=10')
        .expect(200);

      expect(res.body.meta.hasNextPage).toBe(false);
      expect(res.body.meta.hasPreviousPage).toBe(true);
    });

    it('should set hasPreviousPage correctly on first page', async () => {
      const res = await request(app.getHttpServer())
        .get('/pets?page=1&limit=10')
        .expect(200);

      expect(res.body.meta.hasPreviousPage).toBe(false);
      expect(res.body.meta.hasNextPage).toBe(true);
    });
  });

  describe('Filtering + Pagination', () => {
    it('should paginate filtered results by species', async () => {
      const res = await request(app.getHttpServer())
        .get('/pets?species=DOG&page=1&limit=10')
        .expect(200);

      expect(res.body.data.length).toBeGreaterThan(0);
      expect(res.body.data.every((pet: any) => pet.species === 'DOG')).toBe(
        true,
      );
      expect(res.body.meta.total).toBeGreaterThan(0);
    });

    it('should paginate search results', async () => {
      const res = await request(app.getHttpServer())
        .get('/pets?search=Golden&limit=5')
        .expect(200);

      expect(res.body.data.length).toBeGreaterThan(0);
      expect(
        res.body.data.every(
          (pet: any) =>
            pet.name.includes('Golden') || pet.breed?.includes('Golden'),
        ),
      ).toBe(true);
    });

    it('should combine species filter with pagination', async () => {
      const res = await request(app.getHttpServer())
        .get('/pets?species=CAT&page=1&limit=5')
        .expect(200);

      expect(res.body.data.length).toBeGreaterThan(0);
      expect(res.body.data.every((pet: any) => pet.species === 'CAT')).toBe(
        true,
      );
      expect(res.body.meta.page).toBe(1);
      expect(res.body.meta.limit).toBe(5);
    });
  });

  describe('Edge Cases', () => {
    it('should handle page beyond total', async () => {
      const res = await request(app.getHttpServer())
        .get('/pets?page=999')
        .expect(200);

      expect(res.body.data).toHaveLength(0);
      expect(res.body.meta.total).toBe(45);
      expect(res.body.meta.hasNextPage).toBe(false);
    });

    it('should handle limit larger than total', async () => {
      const res = await request(app.getHttpServer())
        .get('/pets?limit=100')
        .expect(200);

      expect(res.body.data).toHaveLength(45);
      expect(res.body.meta.totalPages).toBe(1);
      expect(res.body.meta.hasNextPage).toBe(false);
    });

    it('should handle empty filter results', async () => {
      const res = await request(app.getHttpServer())
        .get('/pets?species=BIRD') // No birds in our test data
        .expect(200);

      expect(res.body.data).toHaveLength(0);
      expect(res.body.meta.total).toBe(0);
      expect(res.body.meta.totalPages).toBe(0);
      expect(res.body.meta.hasNextPage).toBe(false);
      expect(res.body.meta.hasPreviousPage).toBe(false);
    });

    it('should maintain order across pages', async () => {
      const page1 = await request(app.getHttpServer())
        .get('/pets?page=1&limit=10')
        .expect(200);

      const page2 = await request(app.getHttpServer())
        .get('/pets?page=2&limit=10')
        .expect(200);

      // Ensure both pages have data
      expect(page1.body.data.length).toBeGreaterThan(0);
      expect(page2.body.data.length).toBeGreaterThan(0);

      // Ensure no overlap between pages
      const page1Ids = page1.body.data.map((pet: any) => pet.id);
      const page2Ids = page2.body.data.map((pet: any) => pet.id);
      const overlap = page1Ids.filter((id: string) => page2Ids.includes(id));

      // No overlap means proper pagination
      expect(overlap).toHaveLength(0);
    });
  });

  describe('Response Structure', () => {
    it('should return correct response structure', async () => {
      const res = await request(app.getHttpServer())
        .get('/pets?page=1&limit=5')
        .expect(200);

      expect(res.body).toHaveProperty('data');
      expect(res.body).toHaveProperty('meta');
      expect(Array.isArray(res.body.data)).toBe(true);

      expect(res.body.meta).toHaveProperty('page');
      expect(res.body.meta).toHaveProperty('limit');
      expect(res.body.meta).toHaveProperty('total');
      expect(res.body.meta).toHaveProperty('totalPages');
      expect(res.body.meta).toHaveProperty('hasNextPage');
      expect(res.body.meta).toHaveProperty('hasPreviousPage');
    });

    it('should return pets with all required fields', async () => {
      const res = await request(app.getHttpServer())
        .get('/pets?limit=1')
        .expect(200);

      expect(res.body.data).toHaveLength(1);
      const pet = res.body.data[0];

      expect(pet).toHaveProperty('id');
      expect(pet).toHaveProperty('name');
      expect(pet).toHaveProperty('species');
      expect(pet).toHaveProperty('status');
      expect(pet).toHaveProperty('createdAt');
      expect(pet).toHaveProperty('updatedAt');
    });
  });
});

